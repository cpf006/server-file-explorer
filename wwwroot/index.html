<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>File Explorer</title>
</head>
<body>
    <h1>File Explorer</h1>
    <div id="controls">
        <input type="text" id="search" placeholder="Search" />
        <button id="searchBtn">Search</button>
        <input type="file" id="uploadFile" />
        <button id="uploadBtn">Upload</button>
        <button id="zipBtn">Download Zip</button>
    </div>
    <div id="stats"></div>
    <ul id="listing"></ul>
    <script>
        const apiBase = '/api/files';

        function load() {
            const params = new URLSearchParams(window.location.search);
            const path = params.get('path') || '';
            fetch(apiBase + '?path=' + encodeURIComponent(path))
                .then(r => r.json())
                .then(data => {
                    document.getElementById('stats').textContent =
                        `Folders: ${data.stats.directoryCount}, Files: ${data.stats.fileCount}, Size: ${data.stats.totalSize} bytes`;

                    const list = document.getElementById('listing');
                    list.innerHTML = '';

                    if (path) {
                        const parent = path.split('/').slice(0, -1).join('/');
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="?path=${encodeURIComponent(parent)}">..</a>`;
                        list.appendChild(li);
                    }

                    data.directories.forEach(d => {
                        const li = document.createElement('li');
                        const newPath = (path ? path + '/' : '') + d;
                        li.innerHTML = `<input type="checkbox" value="${newPath}" /> <a href="?path=${encodeURIComponent(newPath)}">${d}/</a>`;
                        list.appendChild(li);
                    });

                    data.files.forEach(f => {
                        const li = document.createElement('li');
                        const filePath = (path ? path + '/' : '') + f.name;
                        li.innerHTML = `<input type="checkbox" value="${filePath}" /> ${f.name} (${f.size} bytes) <a href="${apiBase}/download?path=${encodeURIComponent(filePath)}">download</a>`;
                        list.appendChild(li);
                    });

                    document.getElementById('uploadBtn').onclick = () => {
                        const fileInput = document.getElementById('uploadFile');
                        const file = fileInput.files[0];
                        if (!file) return;
                        const form = new FormData();
                        form.append('file', file);
                        fetch(apiBase + '/upload?path=' + encodeURIComponent(path), {
                            method: 'POST',
                            body: form
                        }).then(() => load());
                    };

                    document.getElementById('searchBtn').onclick = () => {
                        const q = document.getElementById('search').value;
                        fetch(apiBase + '/search?query=' + encodeURIComponent(q))
                            .then(r => r.json())
                            .then(showSearch);
                    };
                    document.getElementById('zipBtn').onclick = () => {
                        const selected = Array.from(document.querySelectorAll('#listing input[type=checkbox]:checked')).map(cb => cb.value);
                        if (selected.length === 0) return;
                        fetch(apiBase + '/zip', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(selected)
                        }).then(r => r.blob())
                          .then(blob => {
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = 'files.zip';
                              document.body.appendChild(a);
                              a.click();
                              a.remove();
                              URL.revokeObjectURL(url);
                          });
                    };
                });
        }

        function showSearch(data) {
            const list = document.getElementById('listing');
            list.innerHTML = '';
            data.directories.forEach(d => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="checkbox" value="${d.path}" /> <strong>Dir:</strong> <a href="?path=${encodeURIComponent(d.path)}">${d.path}</a>`;
                list.appendChild(li);
            });
            data.files.forEach(f => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="checkbox" value="${f.path}" /> <strong>File:</strong> ${f.path} (${f.size} bytes) <a href="${apiBase}/download?path=${encodeURIComponent(f.path)}">download</a>`;
                list.appendChild(li);
            });
            document.getElementById('stats').textContent = 'Search results';
        }

        window.onload = load;
    </script>
</body>
</html>
